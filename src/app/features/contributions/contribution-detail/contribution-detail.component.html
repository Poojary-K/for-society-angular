<div class="contribution-detail">
  @if (loading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>Loading contribution details...</p>
    </div>
  }

  @else if (contribution()) {
    <div class="detail-header">
      <button class="back-button" (click)="goBack()">
        <i class="fas fa-arrow-left"></i> Back to Contributions
      </button>
      @if (canEdit) {
        <div class="action-buttons">
          <app-button type="secondary" (click)="editContribution()">
            <i class="fas fa-edit"></i> Edit
          </app-button>
          <app-button type="secondary" (click)="deleteContribution()">
            <i class="fas fa-trash"></i> Delete
          </app-button>
        </div>
      }
    </div>

    <app-card variant="elevated" class="contribution-detail-card">
      <div class="contribution-header">
        <div class="contribution-amount-large">{{ formatAmount(contribution()!.amount) }}</div>
        <div class="contribution-label">Contribution Amount</div>
      </div>

      <div class="contribution-info">
        <div class="info-item">
          <div class="info-label">
            <i class="fas fa-calendar-alt"></i>
            <span>Contribution Date</span>
          </div>
          <div class="info-value">{{ formatDate(contribution()!.contributeddate) }}</div>
        </div>

        <div class="info-item">
          <div class="info-label">
            <i class="fas fa-clock"></i>
            <span>Created On</span>
          </div>
          <div class="info-value">{{ formatDate(contribution()!.createdat) }}</div>
        </div>

        @if (isAdmin && member()) {
          <div class="info-item">
            <div class="info-label">
              <i class="fas fa-user"></i>
              <span>Member</span>
            </div>
            <div class="info-value">{{ member()!.name }}</div>
            @if (member()!.email) {
              <div class="info-subvalue">{{ member()!.email }}</div>
            }
          </div>
        }
      </div>
    </app-card>

    <app-card variant="outlined" class="images-card">
      <div class="images-header">
        <div class="images-title">
          <h3>Contribution Images</h3>
          <p>Upload one or multiple images for this contribution.</p>
        </div>
        <div class="images-header-actions">
          @if (canEdit) {
            <label class="upload-btn" [class.disabled]="imagesUploading()">
              <input
                type="file"
                accept="image/*"
                multiple
                (change)="onContributionImagesSelected($event)"
                [disabled]="imagesUploading()"
              />
              <i class="fas fa-upload"></i>
              <span>{{ imagesUploading() ? 'Uploading...' : 'Upload Images' }}</span>
            </label>
          }
          <button class="toggle-btn" (click)="toggleImagesExpanded()" [attr.aria-expanded]="imagesExpanded()">
            <i class="fas" [class.fa-chevron-down]="!imagesExpanded()" [class.fa-chevron-up]="imagesExpanded()"></i>
          </button>
        </div>
      </div>

      @if (imagesExpanded()) {
        @if (imagesLoading()) {
          <div class="images-loading">Loading images...</div>
        } @else if (images().length === 0) {
          <div class="images-empty">No images uploaded yet.</div>
        } @else {
          <div class="images-grid">
            @for (image of images(); track image.imageid; let i = $index) {
              <div class="image-item" (click)="openImageViewer(i)">
                <div class="image-placeholder">
                  <i class="fas fa-image"></i>
                </div>
                <div class="image-details">
                  <div class="image-title">Image {{ i + 1 }}</div>
                  <div class="image-meta">Uploaded {{ formatDate(image.createdat) }}</div>
                </div>
                @if (canEdit) {
                  <div class="image-actions">
                    <label
                      class="image-action-btn"
                      [class.disabled]="replacingImageId() === image.imageid"
                      (click)="$event.stopPropagation()"
                    >
                      <input
                        type="file"
                        accept="image/*"
                        (change)="onReplaceContributionImage(image, $event)"
                        [disabled]="replacingImageId() === image.imageid"
                      />
                      <i class="fas fa-sync-alt"></i>
                      <span>{{ replacingImageId() === image.imageid ? 'Replacing...' : 'Replace' }}</span>
                    </label>
                    <button
                      class="image-action-btn delete"
                      (click)="$event.stopPropagation(); deleteContributionImage(image)"
                      [disabled]="deletingImageId() === image.imageid"
                    >
                      <i class="fas fa-trash"></i>
                      <span>{{ deletingImageId() === image.imageid ? 'Deleting...' : 'Delete' }}</span>
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        }
      }
    </app-card>

    @if (imageViewerOpen() && activeImage) {
      <div class="image-viewer-backdrop" (click)="closeImageViewer()">
        <div class="image-viewer" (click)="$event.stopPropagation()">
          <button class="viewer-close" (click)="closeImageViewer()" aria-label="Close image viewer">
            <i class="fas fa-times"></i>
          </button>
          <div class="viewer-content">
            @if (images().length > 1) {
              <button class="viewer-nav prev" (click)="prevImage()" aria-label="Previous image">
                <i class="fas fa-chevron-left"></i>
              </button>
            }
            <div class="viewer-image">
              @if (hasImageError(activeImage)) {
                <div class="viewer-error">
                  <i class="fas fa-exclamation-triangle"></i>
                  <p>Preview unavailable. Open the image in a new tab.</p>
                  <a class="viewer-link" [href]="activeImage.url" target="_blank" rel="noopener">
                    Open Image
                  </a>
                </div>
              } @else {
                <img
                  [src]="activeImage.url"
                  [alt]="'Contribution image ' + activeImage.imageid"
                  (error)="onViewerImageError(activeImage, $event)"
                />
              }
            </div>
            @if (images().length > 1) {
              <button class="viewer-nav next" (click)="nextImage()" aria-label="Next image">
                <i class="fas fa-chevron-right"></i>
              </button>
            }
          </div>
          <div class="viewer-footer">
            {{ activeImageIndex() + 1 }} / {{ images().length }}
          </div>
        </div>
      </div>
    }

    <app-edit-contribution
      [contribution]="contribution()!"
      [members]="members()"
      (contributionUpdated)="onContributionUpdated($event)"
    />
  }

  @else {
    <app-card variant="outlined" class="error-card">
      <div class="error-state">
        <i class="fas fa-exclamation-circle"></i>
        <h3>Contribution not found</h3>
        <p>The contribution you're looking for doesn't exist or has been removed.</p>
        <app-button type="primary" (click)="goBack()">Go Back</app-button>
      </div>
    </app-card>
  }
</div>
